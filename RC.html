<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matchly | Live Chat</title>
    <style>
        body { margin: 0; background: #000; color: #fff; font-family: sans-serif; height: 100vh; overflow: hidden; }
        .top-bar { position: fixed; top: 0; width: 100%; padding: 20px; display: flex; justify-content: space-between; z-index: 10; background: rgba(0,0,0,0.5); }
        .online-counter { color: #00ff88; border: 1px solid #00ff88; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; }
        .chat-box { height: 100vh; display: flex; flex-direction: column; padding-top: 80px; box-sizing: border-box; }
        #msgContainer { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .bubble { padding: 12px 18px; border-radius: 20px; max-width: 70%; word-wrap: break-word; }
        .you { align-self: flex-end; background: #fff; color: #000; }
        .stranger { align-self: flex-start; background: #222; border: 1px solid #444; }
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; justify-content: center; align-items: center; z-index: 100; }
        .input-area { padding: 20px; display: flex; gap: 10px; background: #111; }
        #userInput { flex: 1; padding: 15px; border-radius: 30px; border: none; background: #222; color: #fff; outline: none; }
        .next-btn { background: #ff4444; border: none; color: white; padding: 0 20px; border-radius: 30px; cursor: pointer; }
    </style>
</head>
<body>

<div id="loader" class="loader"><h2>FINDING A STRANGER...</h2></div>

<div class="top-bar">
    <div style="font-weight:bold; letter-spacing:2px;">MATCHLY</div>
    <div class="online-counter" id="onlineCount">4,281 ONLINE</div>
</div>

<div class="chat-box">
    <div id="msgContainer"></div>
    <div class="input-area">
        <button class="next-btn" onclick="location.reload()">NEXT</button>
        <input type="text" id="userInput" placeholder="Type a message..." autocomplete="off">
    </div>
</div>

<script>
    // Get gender from localStorage (saved in gender.html)
const userGender = localStorage.getItem('userGender') || 'male'; 
const socket = new WebSocket("wss://your-render-link.onrender.com");

socket.onopen = () => {
    // Register gender as soon as connected
    socket.send(JSON.stringify({ type: "register", gender: userGender }));
};

socket.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    
    if (msg.type === "system") {
        addSystemMsg(msg.text);
        if(msg.text.includes("Connected")) document.getElementById('loader').style.display = 'none';
    } 
    else if (msg.type === "chat") {
        addMessage(msg.text, "stranger");
    }
    else if (msg.type === "ai_reply") {
        addMessage(msg.text, "ai-bot");
    }
};

function handleSend() {
    const input = document.getElementById('userInput');
    const text = input.value.trim();
    if (!text) return;

    // Send to partner
    socket.send(JSON.stringify({ type: "chat", text: text }));
    addMessage(text, "you");
    
    // Optional: Ask AI if message starts with "/bot"
    if (text.startsWith("/bot")) {
        socket.send(JSON.stringify({ type: "ai_query", text: text }));
    }
    
    input.value = "";
}
    // 1. IMPORTANT: Replace this with your RENDER URL after you finish Step 3
    const SERVER_URL = "wss://matchly-8ljs.onrender.com"; 
    
    let socket;

    function connect() {
        socket = new WebSocket(SERVER_URL);

        socket.onmessage = (event) => {
            const data = event.data;
            if (data === "Connected to stranger") {
                document.getElementById('loader').style.display = 'none';
                addSystemMsg("Stranger connected! Say hi.");
            } else if (data === "Stranger disconnected") {
                addSystemMsg("Stranger left. Click NEXT to find another.");
                socket.close();
            } else if (data !== "Waiting for stranger...") {
                addMsg(data, 'stranger');
            }
        };
    }

    function addMsg(text, type) {
        const container = document.getElementById('msgContainer');
        const div = document.createElement('div');
        div.className = `bubble ${type}`;
        div.textContent = text;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }

    function addSystemMsg(text) {
        const div = document.createElement('div');
        div.style.cssText = "text-align:center; color:#666; font-size:0.8rem; margin:10px;";
        div.textContent = text;
        document.getElementById('msgContainer').appendChild(div);
    }

    document.getElementById('userInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && e.target.value.trim() !== "") {
            socket.send(e.target.value);
            addMsg(e.target.value, 'you');
            e.target.value = "";
        }
    });

    connect();
</script>
</body>
</html>

